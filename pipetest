stages:
  - build
  - push

variables:
  IMAGE_NAME: "$CI_PROJECT_NAME"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  NEXUS_REPO_USER: "svc-apim-cicd-dev"
  NEXUS_REPO_PASS: "F_arX1Z%fIQSfZEM@aJL9RRk*"
  NEXUS_REGISTRY: "fmk.nexus-ci.onefiserv.net"
  NEXUS_REPO_PATH: "apm/0006528"
  FMK_PROD: "fmk.nexus.onefiserv.net"
  FMK_OPENJDK_IMAGE: "$FMK_PROD/fmk/java/openjdk-17-maven:FMK-12-01-23"
  FULL_IMAGE_NAME: "$NEXUS_REGISTRY/$NEXUS_REPO_PATH/$IMAGE_NAME:$IMAGE_TAG"
  MAVEN_CLI_OPTS: "-s $CI_PROJECT_DIR/.m2/cicd-settings.xml --batch-mode"
  JAR_NAME: "$CI_PROJECT_NAME-0.0.1-SNAPSHOT.jar"

default:
  tags:
    - apihub-shell-prod

package_react:
  stage: build
  rules:
    - exists:
        - package.json
    - changes:
        - "**/*.js"
        - "**/*.jsx"
  script:
    - echo "Detected React project"
    - npm install
    - npm run build

package_node:
  stage: build
  rules:
    - exists:
        - package.json
    - changes:
        - "**/*.js"
  script:
    - echo "Detected Node.js project"
    - npm install
    - npm run build

package_python:
  stage: build
  rules:
    - exists:
        - requirements.txt
  script:
    - echo "Detected Python project"
    - pip install -r requirements.txt

package_java:
  stage: build
  rules:
    - exists:
        - pom.xml
  image: $FMK_OPENJDK_IMAGE
  script:
    - echo "Detected Java project"
    - mvn $MAVEN_CLI_OPTS clean install -DskipTests
  artifacts:
    paths:
      - "target/$JAR_NAME"

build_and_push_image:
  stage: push
  needs:
    - job: package_react
      optional: true
    - job: package_node
      optional: true
    - job: package_python
      optional: true
    - job: package_java
      optional: true
  script:
    - echo "Logging in to Nexus Docker registry..."
    - echo "$NEXUS_REPO_PASS" | docker login -u $NEXUS_REPO_USER --password-stdin $NEXUS_REGISTRY
    - echo "Building Docker image..."
    - docker build --build-arg jarname=$JAR_NAME -t $FULL_IMAGE_NAME .
    - echo "Pushing Docker image to Nexus..."
    - docker push $FULL_IMAGE_NAME
  rules:
    - changes:
        - "**/*"
